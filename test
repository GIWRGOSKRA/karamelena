<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Μετρητής Υδατανθράκων</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font and apply rounded corners -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            background-color: #f7f9fb;
            font-family: 'Inter', sans-serif;
        }
        .card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            background-color: white;
        }
        .pulse-animation {
            animation: pulse-loader 1.5s infinite;
        }
        @keyframes pulse-loader {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 md:p-10 rounded-xl space-y-6">
            <h1 class="text-3xl font-extrabold text-gray-800 text-center"> </h1>
            <p class="text-gray-500 text-center">Λενα μου ειναι απλο,γραφεις το φαγητο που καταναλωσες και αυτο θα σου δωσει τα γραμμαρια υδατανθρακων που περιεχει στα 100    γραμμάρια</p>

            <!-- Search Input and Button -->
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="foodSearchInput" placeholder="π.χ., 'μαγειρεμένο καστανό ρύζι' ή 'μήλο'"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       aria-label="Πεδίο αναζήτησης τροφίμου">
                <button id="searchButton"
                        class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out disabled:bg-blue-400">
                    Αναζήτηση
                </button>
            </div>

            <!-- Result Area -->
            <div id="resultContainer" class="min-h-32 p-4 border border-gray-200 rounded-lg hidden">

                <!-- Loading State -->
                <div id="loadingIndicator" class="flex flex-col items-center justify-center space-y-3 hidden">
                    <div class="h-6 w-6 bg-blue-500 rounded-full pulse-animation"></div>
                    <p class="text-blue-600 font-medium">Αναζήτηση διατροφικών δεδομένων...</p>
                </div>

                <!-- Error State -->
                <div id="errorDisplay" class="hidden text-red-600 p-2 bg-red-50 rounded-lg">
                    <p class="font-bold">Προέκυψε σφάλμα:</p>
                    <p id="errorMessage" class="text-sm"></p>
                </div>

                <!-- Success Content -->
                <div id="successContent" class="space-y-4 hidden">
                    <h2 class="text-xl font-bold text-gray-700">Πληροφορίες Υδατανθράκων</h2>
                    <div id="carbResult" class="text-gray-800 text-lg">
                        <!-- Carb count text will be injected here -->
                    </div>

                    <!-- Sources -->
                    <div id="sourcesContainer" class="border-t pt-3 mt-3 text-sm text-gray-500 space-y-2">
                        <p class="font-semibold">Πηγές (Αναζήτηση):</p>
                        <ul id="sourcesList" class="list-disc list-inside space-y-1">
                            <!-- Sources will be injected here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for API setup
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_ENDPOINT_BASE = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=`;
        const MAX_RETRIES = 5;

        // =========================================================================
        // !!! ΕΙΣΑΓΩΓΗ ΚΛΕΙΔΙΟΥ API (ΓΙΑ ΤΟΠΙΚΗ ΧΡΗΣΗ) !!!
        // Εισάγετε το Gemini API Key σας εδώ, ΑΥΣΤΗΡΑ εντός των εισαγωγικών ("...").
        // Αν το αφήσετε κενό (""), η εφαρμογή θα προσπαθήσει να χρησιμοποιήσει το κλειδί από το Canvas.
        const GEMINI_API_KEY = "AIzaSyC5Spavj4WShuGPBkoSOl75-24ka04esmo"; // Αντικαταστήστε το YOUR_API_KEY_HERE με το κλειδί σας.
        // =========================================================================

        // UI Element references
        const foodSearchInput = document.getElementById('foodSearchInput');
        const searchButton = document.getElementById('searchButton');
        const resultContainer = document.getElementById('resultContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const errorMessage = document.getElementById('errorMessage');
        const successContent = document.getElementById('successContent');
        const carbResult = document.getElementById('carbResult');
        const sourcesList = document.getElementById('sourcesList');

        // Helper function for exponential backoff retry logic
        async function fetchWithRetry(url, payload, retries = 0) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error.message || `API request failed with status ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    console.warn(`Request failed. Retrying in ${delay}ms... (${retries + 1}/${MAX_RETRIES})`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, payload, retries + 1);
                }
                throw error;
            }
        }

        // Function to perform the Gemini API call
        async function fetchCarbData(foodItem) {
            // System instruction guides the model to be a concise nutritional assistant and to respond in Greek.
            const systemPrompt = "Είστε ένας εξειδικευμένος διατροφικός βοηθός. Ο στόχος σας είναι να βρείτε την ακριβή συνολική περιεκτικότητα σε υδατάνθρακες (σε γραμμάρια) για το ζητούμενο τρόφιμο ανά 100 γραμμάρια. Δώστε μια ενιαία, συνοπτική παράγραφο με το εύρημα. Εάν δεν είναι διαθέσιμος ένας συγκεκριμένος αριθμός, δώστε την πιο σχετική περίληψη. ΑΠΑΝΤΗΣΤΕ ΑΥΣΤΗΡΑ ΣΤΑ ΕΛΛΗΝΙΚΑ.";
            const userQuery = `Ποια είναι η συνολική περιεκτικότητα σε υδατάνθρακες για το ${foodItem} ανά 100 γραμμάρια;`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Use Google Search for grounding the nutrition data
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            // Build the URL, including the API key
            // If the user hasn't replaced "YOUR_API_KEY_HERE", it will be sent as an empty string,
            // which allows the Canvas runtime to inject the key (if running here).
            const key = GEMINI_API_KEY === "YOUR_API_KEY_HERE" ? "" : GEMINI_API_KEY;
            const apiUrl = API_ENDPOINT_BASE + key;


            try {
                const result = await fetchWithRetry(apiUrl, payload);

                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("Ελήφθη μη έγκυρη δομή απάντησης από το API.");
                }

                // 1. Extract the generated text
                const text = candidate.content.parts[0].text;

                // 2. Extract grounding sources
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                return { text, sources };

            } catch (error) {
                console.error("API Call Error:", error);
                // Updated error message to hint at potential CORS issue or invalid key
                throw new Error(error.message || "Αποτυχία λήψης δεδομένων. Ελέγξτε τη σύνδεση, το κλειδί API και βεβαιωθείτε ότι το αρχείο τρέχει σε τοπικό εξυπηρετητή (local server).");
            }
        }

        // Main function to handle the search process
        async function handleSearch() {
            const foodItem = foodSearchInput.value.trim();
            if (!foodItem) {
                showError("Παρακαλώ εισάγετε ένα τρόφιμο για αναζήτηση.");
                return;
            }

            // Reset UI and show loading state
            resultContainer.classList.remove('hidden');
            errorDisplay.classList.add('hidden');
            successContent.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            searchButton.disabled = true;

            try {
                const data = await fetchCarbData(foodItem);

                // Update results text with Greek labels
                carbResult.innerHTML = `<p class="font-medium">Περιεκτικότητα σε υδατάνθρακες για <span class="text-blue-600 font-bold">${foodItem}</span> ανά 100 γραμμάρια:</p><p class="mt-2 p-3 bg-gray-50 border border-gray-100 rounded-lg">${data.text}</p>`;

                // Update sources
                sourcesList.innerHTML = '';
                if (data.sources.length > 0) {
                    data.sources.forEach(source => {
                        const li = document.createElement('li');
                        li.className = "ml-4";
                        li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-blue-500 hover:text-blue-700 underline transition duration-150">${source.title}</a>`;
                        sourcesList.appendChild(li);
                    });
                    document.getElementById('sourcesContainer').classList.remove('hidden');
                } else {
                     document.getElementById('sourcesContainer').classList.add('hidden');
                }

                // Show success content
                successContent.classList.remove('hidden');

            } catch (error) {
                showError(error.message);
            } finally {
                // Hide loading and re-enable button
                loadingIndicator.classList.add('hidden');
                searchButton.disabled = false;
            }
        }

        // Function to display errors
        function showError(message) {
            resultContainer.classList.remove('hidden');
            successContent.classList.add('hidden');
            loadingIndicator.classList.add('hidden');
            errorDisplay.classList.remove('hidden');
            errorMessage.textContent = message;
        }

        // Event Listeners
        searchButton.addEventListener('click', handleSearch);
        foodSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
    </script>

</body>
</html>
